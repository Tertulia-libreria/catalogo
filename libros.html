<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tertulia Librer√≠a</title>

<!-- Favicon (si lo tienes) -->
<link rel="icon" href="favicon.ico">

<style>
  body{margin:0;font-family:Arial;background:#f2f6ff;padding-bottom:120px;}
  #barra{position:sticky;top:0;background:#0d47a1;padding:12px;z-index:999;color:#fff;display:flex;flex-direction:column;align-items:center;gap:10px;}
  #titulo{font-weight:600;font-size:20px;color:#fff;margin:0;}
  #categoria,#buscador{box-sizing:border-box;width:100%;max-width:520px;padding:10px;border-radius:8px;border:none;font-size:15px;display:block;}
  #categoria,#buscador{background:#fff;}

  .catalogo{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:12px;min-height:300px;}
  .producto{background:white;border-radius:12px;padding:10px;position:relative;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.06);transition:all .3s ease;}
  .producto img{width:100%;max-height:220px;object-fit:contain;border-radius:8px;margin-bottom:8px;}
  .titulo{font-weight:700;margin:0 0 6px;}
  .autor{margin:0 0 8px;color:#333;}
  .precio{color:#0d47a1;font-weight:700;}

  .estado{
  font-size:12px;
  font-weight:600;
  white-space:nowrap;
 }

 .estado.ok{ color:#2e7d32; }
 .estado.no{ color:#c62828; }

  .estrella{
    position:absolute;top:8px;right:8px;width:38px;height:38px;border-radius:50%;
    background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;
    font-size:22px;cursor:pointer;color:#999;transition:.25s;box-shadow:0 2px 6px rgba(0,0,0,.18)
  }
  .estrella.act{color:#FFD700}
/* ===== EFECTO FAVORITOS PRO ===== */

.estrella {
  transition: transform .18s ease, box-shadow .18s ease;
}

.estrella.act {
  box-shadow: 0 0 12px rgba(255, 215, 0, .6);
  animation: starPulse .6s ease;
}

@keyframes starPulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.25); }
  100% { transform: scale(1); }
}

/* contenedor invisible */
.stars-container {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 38px;
  height: 38px;
  pointer-events: none;
  overflow: visible;
}

/* estrellitas */
.tiny-star {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 6px;
  height: 6px;
  background: #FFD700;
  transform: translate(-50%, -50%);
  clip-path: polygon(
    50% 0%, 61% 35%, 98% 35%, 
    68% 57%, 79% 91%, 
    50% 70%, 21% 91%, 
    32% 57%, 2% 35%, 39% 35%
  );
  animation: starExplosion .9s ease-out forwards;
}
@keyframes starExplosion {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  30% {
    transform: translate(-50%, -50%) scale(1.2);
    opacity: 1;
  }
  100% {
    transform: translate(calc(-50% + var(--x)), calc(-50% + var(--y)))
               scale(0) rotate(360deg);
    opacity: 0;
  }
}

  .botones-flotantes{position:fixed;bottom:20px;right:15px;display:flex;flex-direction:column;gap:10px;z-index:998}
  #favoritosBtn,#volverBtn,#whatsapp{
    border:none;border-radius:50%;width:50px;height:50px;font-size:20px;
    display:flex;align-items:center;justify-content:center;cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,.25)
  }
  #favoritosBtn,#volverBtn{background:#0d47a1;color:#fff}
  #volverBtn{display:none}
  #whatsapp{background:#25D366;color:white;text-decoration:none}

  .paginacion{display:flex;justify-content:center;gap:6px;margin:15px;flex-wrap:wrap}
  .paginacion button{padding:6px 12px;border-radius:4px;border:1px solid #ccc;background:white;cursor:pointer}
  .paginacion button.active{background:#0d47a1;color:white}

  @media(min-width:700px){
    #barra{flex-direction:row;justify-content:space-between}
    #titulo{width:25%}
    #categoria,#buscador{width:35%}
  }
</style>
</head>

<body>

<div id="barra">
  <div id="titulo">Tertulia librer√≠a</div>
  <select id="categoria">
    <option value="">üìÇ Todas las categor√≠as</option>
  </select>
  <input id="buscador" placeholder="üîç Buscar por t√≠tulo o autor">
</div>

<div class="catalogo" id="catalogo"></div>

<div class="paginacion" id="paginacion">
  <button onclick="cambiarPagina(paginaActual-1)">‚Üê</button>
  <span id="contadorPagina"></span>
  <button onclick="cambiarPagina(paginaActual+1)">‚Üí</button>
</div>
 
<div id="contadorCategorias" style="
  text-align:center;
  font-size:14px;
  color:#555;
  margin-bottom:10px;
">
</div>

<div class="botones-flotantes">
  <button id="volverBtn" onclick="volverACategorias()">‚Üê</button>
  <button id="favoritosBtn" onclick="mostrarFavoritos()">‚≠ê</button>
  <a id="whatsapp" href="https://wa.me/524751070540" target="_blank">üí¨</a>
</div>

<script>
/* ================= CONFIG ================= */
var numero = "524751070540";
var libros = [];
var favs = [];
var librosPorPagina = 40;
var paginaActual = 1;
var librosFiltrados = [];
var todosLibros = [];
var viendoFavs = false;
var productosPendientes = [];
var renderizando = false;
function normalizar(texto){
  return texto
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim();
}

function actualizarContadorCategorias(){
  const categoria = document.getElementById("categoria").value;
  const total = librosFiltrados.length;

  let texto = "";

  if (viendoFavs) {
    texto = "Favoritos - " + total + " libros";
  } 
  else if (categoria) {
    texto = categoria + " - " + total + " libros";
  } 
  else {
    texto = "Todas las categor√≠as - " + total + " libros";
  }

  document.getElementById("contadorCategorias").textContent = texto;
}
/* ================= FETCH JSON ================= */
fetch("https://script.google.com/macros/s/AKfycby0I4zJSTM1bpWNB0QVpktidbyuXDzZFa1EjfZblZ0zwhkBrtAxYU45BQT88uHZhZYGPQ/exec")
  .then(r => r.json())
  .then(data => {
    libros = data.libros || [];
    construirCategorias(libros);
    construirCatalogo(libros);
    inicializar();
  });

/* ================= BUILD ================= */
function construirCategorias(libros){
  const sel = document.getElementById("categoria");
  sel.innerHTML = '<option value="">üìÇ Todas las categor√≠as</option>';

  const categorias = [...new Set(libros.map(l => l.categoria).filter(Boolean))].sort();

  categorias.forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    sel.appendChild(o);
  });
}
function construirCatalogo(libros){
  const c = document.getElementById("catalogo");
  c.innerHTML = "";

  todosLibros = []; // üîë resetear aqu√≠

  const primeros = libros.slice(0, librosPorPagina);
  productosPendientes = libros.slice(librosPorPagina);

  primeros.forEach(L => {
    const prod = crearProducto(L);
    c.appendChild(prod);
    todosLibros.push(prod);
  });

  cargarEnSegundoPlano();
}
function crearProducto(L){
  const d = document.createElement("div");
  d.className = "producto";
  d.dataset.titulo = String(L.titulo || "").toLowerCase();
  d.dataset.autor  = String(L.autor  || "").toLowerCase();
  d.dataset.categoria = L.categoria || "";

  d.innerHTML = `
    <div class="estrella" onclick="toggleFav(this)">‚òÜ</div>
    <div class="stars-container"></div>

    <a href="https://wa.me/${numero}?text=${encodeURIComponent(
      "Hola! Me interesa " + L.titulo + " $" + L.precio
    )}" target="_blank" style="color:inherit;text-decoration:none">

      <img 
        src="${L.imagen}"
        loading="lazy"
        decoding="async"
        width="200"
        height="200"
      >

      <div class="titulo">${L.titulo}</div>
      <div class="autor">${L.autor}</div>

      <div class="precio">
        $${L.precio} MXN ¬∑ 
        <span class="estado ${L.existencia > 0 ? 'ok' : 'no'}">
          ${L.existencia > 0 ? "‚úî Disponible" : "‚úñ Agotado"}
        </span>
      </div>
    </a>
  `;

  return d;
}

function cargarEnSegundoPlano(){
  if(renderizando || productosPendientes.length === 0) return;
  renderizando = true;

  const cargar = () => {
    const c = document.getElementById("catalogo");
    let contador = 0;

    while(productosPendientes.length && contador < 10){
      const prod = crearProducto(productosPendientes.shift());
      c.appendChild(prod);
      todosLibros.push(prod); // ‚úîÔ∏è aqu√≠ S√ç est√° bien
      contador++;
    }

    renderizando = false;

// üîÅ reaplicar paginaci√≥n solo si estamos en vista normal//
if (!viendoFavs && !document.getElementById("categoria").value) {
  librosFiltrados = [...todosLibros];
  mostrarPagina(paginaActual);
}

    if(productosPendientes.length){
      if("requestIdleCallback" in window){
        requestIdleCallback(cargar);
      } else {
        setTimeout(cargar, 120);
      }
    }
  };

  cargar();
}

function inicializar(){
  librosFiltrados = [...todosLibros];
  favs = JSON.parse(localStorage.getItem("favoritosTertulia") || "[]");

  todosLibros.forEach(p => {
    const titulo = p.querySelector(".titulo").innerText;
    const estrella = p.querySelector(".estrella");

    if (favs.includes(titulo)) {
      estrella.textContent = "‚òÖ";
      estrella.classList.add("act");
    }
  });

  mostrarPagina(1);
actualizarContadorCategorias();
}

  

/* ================= PAGINACI√ìN ================= */
function mostrarPagina(p){
  paginaActual = p;

  const totalPaginas = Math.ceil(librosFiltrados.length / librosPorPagina);
  if (paginaActual < 1) paginaActual = 1;
  if (paginaActual > totalPaginas) paginaActual = totalPaginas;

  todosLibros.forEach(x => x.style.display = "none");

  librosFiltrados
    .slice((paginaActual - 1) * librosPorPagina, paginaActual * librosPorPagina)
    .forEach(x => x.style.display = "block");

  document.getElementById("contadorPagina").textContent =
    "P√°gina " + paginaActual + " / " + totalPaginas;

  actualizarContadorCategorias();

  // üîù subir al inicio al cambiar p√°gina
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
}

function cambiarPagina(p){
  const totalPaginas = Math.ceil(librosFiltrados.length / librosPorPagina);
  if (p < 1 || p > totalPaginas) return;
  mostrarPagina(p);
}



/* ================= FILTROS ================= */
document.getElementById("buscador").oninput=filtrar;
document.getElementById("categoria").onchange=filtrar;

function filtrar(){
  const texto = normalizar(
    document.getElementById("buscador").value
  );

  const categoria = document.getElementById("categoria").value;

  viendoFavs = false;
  document.getElementById("volverBtn").style.display = "none";

  librosFiltrados = todosLibros.filter(p => {
    const titulo = normalizar(p.dataset.titulo || "");
    const autor  = normalizar(p.dataset.autor || "");
    const cat    = p.dataset.categoria || "";

    const coincideTexto =
      titulo.includes(texto) || autor.includes(texto);

    // üîë Si hay texto ‚Üí ignora categor√≠a
    if (texto.length > 0) {
      return coincideTexto;
    }

    // üîë Si no hay texto ‚Üí usa categor√≠a
    return !categoria || cat === categoria;
  });

  mostrarPagina(1);
actualizarContadorCategorias();
}

/* ================= FAVORITOS ================= */
function toggleFav(el){
  const producto = el.closest(".producto");
  const titulo = producto.querySelector(".titulo").innerText;

  if (favs.includes(titulo)) {
    // ‚ùå quitar favorito
    favs = favs.filter(t => t !== titulo);
    el.textContent = "‚òÜ";
    el.classList.remove("act");

    // üëá si estamos viendo favoritos ‚Üí quitar al instante
    if (viendoFavs) {
      producto.remove();
      librosFiltrados = librosFiltrados.filter(p => p !== producto);
      mostrarPagina(paginaActual);
    }

  } else {
    // ‚≠ê agregar favorito
    favs.push(titulo);
    el.textContent = "‚òÖ";
    el.classList.add("act");
    efectoEstrellas(el);
  }

  localStorage.setItem("favoritosTertulia", JSON.stringify(favs));
}
 function efectoEstrellas(btn){
  const cont = btn.parentElement.querySelector(".stars-container");
  cont.innerHTML = "";

  const total = 12 + Math.floor(Math.random() * 4);

  for(let i=0;i<total;i++){
    const s = document.createElement("div");
    s.className = "tiny-star";

    const x1 = (Math.random()*30 - 15) + "px";
    const y1 = (Math.random()*30 - 15) + "px";
    const x2 = (Math.random()*60 - 30) + "px";
    const y2 = (Math.random()*60 - 30) + "px";

    s.style.setProperty("--x", x1);
    s.style.setProperty("--y", y1);
    s.style.setProperty("--x2", x2);
    s.style.setProperty("--y2", y2);

    cont.appendChild(s);
  }

  setTimeout(() => cont.innerHTML = "", 900);
}

function mostrarFavoritos(){
  viendoFavs = true;

  // filtrar solo favoritos
  librosFiltrados = todosLibros.filter(p =>
    favs.includes(p.querySelector(".titulo").innerText)
  );

  // mostrar bot√≥n volver
  document.getElementById("volverBtn").style.display = "block";

  mostrarPagina(1);
actualizarContadorCategorias();
}

function volverACategorias(){
  viendoFavs=false;
  librosFiltrados=[...todosLibros];
  mostrarPagina(1);
  document.getElementById("volverBtn").style.display="none";
}
</script>

</body>
</html>